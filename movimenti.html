<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Cantiere | Carico e Scarico</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --cantiere-gold: #ffc107; --cantiere-dark: #121212; }
        body { background-color: var(--cantiere-dark); color: #fff; font-family: 'Inter', sans-serif; }
        .card-movimento { background: #1e1e1e; border: 1px solid #333; border-radius: 15px; padding: 2rem; }
        .form-control, .form-select { background: #2a2a2a; border: 1px solid #444; color: #fff; padding: 12px; }
        .form-control:focus { background: #2a2a2a; color: #fff; border-color: var(--cantiere-gold); box-shadow: none; }
        .btn-carico { background: #28a745; color: #fff; font-weight: 800; border: none; }
        .btn-scarico { background: #dc3545; color: #fff; font-weight: 800; border: none; }
        .unit-label { font-size: 0.75rem; color: var(--cantiere-gold); text-transform: uppercase; font-weight: 700; }
    </style>
</head>
<body>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card-movimento">
                <h3 class="fw-bold text-center mb-4"><i class="bi bi-arrow-left-right text-warning"></i> MOVIMENTO MERCE</h3>
                
                <form id="formMovimento">
                    <div class="mb-3">
                        <label class="small text-secondary">Prodotto</label>
                        <select id="selProdotto" class="form-select" required></select>
                    </div>

                    <div class="mb-3">
                        <label class="small text-secondary">Magazzino</label>
                        <select id="selMagazzino" class="form-select" required></select>
                    </div>

                    <div class="row g-2 mb-4">
                        <div class="col-4 text-center">
                            <label class="unit-label"><i class="bi bi-boxes"></i> Cartoni</label>
                            <input type="number" id="q_ct" class="form-control text-center" value="0">
                        </div>
                        <div class="col-4 text-center">
                            <label class="unit-label"><i class="bi bi-box-fill"></i> Pacchi</label>
                            <input type="number" id="q_pk" class="form-control text-center" value="0">
                        </div>
                        <div class="col-4 text-center">
                            <label class="unit-label"><i class="bi bi-gear-fill"></i> Pezzi</label>
                            <input type="number" id="q_pz" class="form-control text-center" value="0">
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-6">
                            <button type="button" onclick="salva('CARICO')" class="btn btn-carico w-100 p-3">CARICA</button>
                        </div>
                        <div class="col-6">
                            <button type="button" onclick="salva('SCARICO')" class="btn btn-scarico w-100 p-3">SCARICA</button>
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <a href="dashboard.html" class="text-secondary text-decoration-none small">Annulla e torna indietro</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // --- IL BUTTAFUORI ---
    if (!localStorage.getItem('cantiere_user')) { window.location.href = "index.html"; }

    const SUB_URL = "https://jkekmxhrwwidkfoizhde.supabase.co"; 
    const SUB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImprZWtteGhyd3dpZGtmb2l6aGRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NjEwMTcsImV4cCI6MjA4NzAzNzAxN30.U_XxfpAR76Y7bhB_DdUu2CMeuIarR4158dgwITFRWAg";
    const _supabase = supabase.createClient(SUB_URL, SUB_KEY);

    let dbProdotti = [];

    async function init() {
        const { data: p } = await _supabase.from('prodotti').select('*');
        const { data: m } = await _supabase.from('magazzini').select('*').order('nome');
        dbProdotti = p;
        document.getElementById('selProdotto').innerHTML = '<option value="">Seleziona...</option>' + p.map(x => `<option value="${x.id}">${x.nome_prodotto}</option>`).join('');
        document.getElementById('selMagazzino').innerHTML = m.map(x => `<option value="${x.id}">${x.nome}</option>`).join('');
    }

    async function salva(tipo) {
        const pId = document.getElementById('selProdotto').value;
        const mId = document.getElementById('selMagazzino').value;
        if(!pId) return Swal.fire('Ehi!', 'Scegli un prodotto', 'warning');

        const prod = dbProdotti.find(x => x.id === pId);
        const ct = parseInt(document.getElementById('q_ct').value) || 0;
        const pk = parseInt(document.getElementById('q_pk').value) || 0;
        const pz = parseInt(document.getElementById('q_pz').value) || 0;

        const totalePezzi = (ct * prod.pezzi_per_cartone) + (pk * prod.pezzi_per_pacco) + pz;
        if(totalePezzi <= 0) return Swal.fire('Vuoto?', 'Inserisci una quantità', 'info');

        // Logica DB: Cerca giacenza esistente
        const { data: esistente } = await _supabase.from('giacenze').select('*').eq('prodotto_id', pId).eq('magazzino_id', mId).maybeSingle();
        
        let nuovaQty = totalePezzi;
        if(esistente) {
            nuovaQty = (tipo === 'CARICO') ? esistente.quantita_totale_pezzi + totalePezzi : esistente.quantita_totale_pezzi - totalePezzi;
            await _supabase.from('giacenze').update({ quantita_totale_pezzi: nuovaQty }).eq('id', esistente.id);
        } else {
            if(tipo === 'SCARICO') nuovaQty = -totalePezzi;
            await _supabase.from('giacenze').insert([{ prodotto_id: pId, magazzino_id: mId, quantita_totale_pezzi: nuovaQty }]);
        }

        // --- SWEETALERT DI CONFERMA COOL ---
        Swal.fire({
            title: 'Operazione Riuscita!',
            text: `Hai ${tipo === 'CARICO' ? 'caricato' : 'scaricato'} ${totalePezzi} pezzi. Vuoi tornare alla dashboard?`,
            icon: 'success',
            showCancelButton: true,
            confirmButtonColor: '#ffc107',
            cancelButtonColor: '#333',
            confirmButtonText: 'Sì, vai alla Dashboard',
            cancelButtonText: 'No, fai altro carico'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = "dashboard.html";
            } else {
                document.getElementById('formMovimento').reset();
            }
        });
    }

    init();
</script>
</body>
</html>
