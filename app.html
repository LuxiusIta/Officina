<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Magazzino | Cantiere Hambirreria</title>

    <!-- BLOCCO DI SICUREZZA ASSOLUTA -->
    <script>
        let USER = null;
        try {
            const localSession = localStorage.getItem('cantiere_user');
            if (!localSession) throw new Error("No session");
            USER = JSON.parse(localSession);
            if (!USER || !USER.username) throw new Error("Invalid format");
        } catch (e) {
            window.location.replace('index.html');
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --accent: #FFD700; --danger: #FF4444; }
        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background: url('https://i.imgur.com/f0y6jAe.jpeg') no-repeat center center fixed; background-size: cover; color: white; overflow-x: hidden; }
        h1, h2, h3, h4 { font-family: 'Teko', sans-serif; text-transform: uppercase; letter-spacing: 1px; }
        .hidden { display: none !important; }

        .top-header { height: 60px; background: #000; display: flex; align-items: center; padding: 0 15px; border-bottom: 2px solid var(--accent); position: sticky; top: 0; z-index: 100; box-shadow: 0 5px 15px rgba(0,0,0,0.8); }
        .header-title { font-family: 'Teko'; font-size: 28px; flex-grow: 1; color: white; margin-left: 15px; }
        .user-badge { background: #222; padding: 5px 12px; border-radius: 4px; font-size: 14px; color: var(--accent); font-weight: bold; border: 1px solid #444; }
        .icon-btn { background: none; border: none; color: var(--accent); font-size: 26px; cursor: pointer; padding: 5px; }

        #sidebar { position: fixed; top: 0; left: -280px; width: 280px; height: 100vh; background: #000; z-index: 2000; transition: 0.3s; border-right: 2px solid var(--accent); display: flex; flex-direction: column; }
        #sidebar.active { left: 0; }
        #sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: rgba(0,0,0,0.8); z-index: 1999; display: none; backdrop-filter: blur(5px); }
        #sidebar-overlay.active { display: block; }
        .sidebar-top { padding: 30px 20px; background: #111; border-bottom: 1px solid #333; }
        .nav-links { overflow-y: auto; flex: 1; }
        .nav-links a { display: block; padding: 12px 15px; color: #ccc; text-decoration: none; border-left: 4px solid transparent; font-size: 15px; cursor: pointer; border-bottom: 1px solid #1a1a1a; }
        .nav-links a.active { background: #1a1a1a; color: white; border-left-color: var(--accent); }
        .btn-logout { width: 100%; padding: 12px; background: #111; color: var(--danger); border: 1px solid #333; cursor: pointer; font-weight: bold; font-family: 'Teko'; font-size: 20px; }

        #main-content { display: flex; justify-content: center; padding-top: 20px; }
        .desktop-wrapper { width: 100%; max-width: 900px; padding: 20px; background: rgba(18, 18, 18, 0.95); border-radius: 8px; min-height: 90vh; border: 1px solid #333; margin-bottom: 50px; }

        .btn-neon { background: var(--accent); color: #000; font-family: 'Teko'; font-size: 22px; border: none; padding: 12px; width: 100%; border-radius: 6px; font-weight: 700; cursor: pointer; }
        .dark-input, .dark-select { background: #000; border: 1px solid #444; color: white; padding: 8px 12px; border-radius: 6px; width: 100%; box-sizing: border-box; text-align: center; }
        
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .card-item { background: #1e1e1e; border-radius: 8px; padding: 10px; border: 1px solid #333; text-align: center; }
        .unit-pill { display: inline-flex; align-items: center; gap: 4px; padding: 1px 5px; border-radius: 4px; font-size: 11px; font-weight: bold; border: 1px solid rgba(255,255,255,0.1); margin: 2px; background: #111;}
        .icon-box { color: #D2691E; border-color: #D2691E; } .icon-pack { color: #00BFFF; border-color: #00BFFF; } .icon-piece { color: #ffffff; border-color: #ffffff; }

        .search-wrapper { position: relative; margin-bottom: 15px; }
        .search-wrapper i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--accent); }
        .search-wrapper input { padding-left: 45px !important; text-align: left !important; }

        .swal-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px; }
        .swal-field { display: flex; flex-direction: column; align-items: center; background: #000; padding: 10px; border-radius: 6px; border: 1px solid #333; }
        .swal-field input { width: 50px; background: transparent; border: none; color: white; text-align: center; font-size: 22px; font-weight: bold; outline: none; }
        div:where(.swal2-container) div:where(.swal2-popup) { background: #151515 !important; border: 2px solid var(--accent) !important; }

        .prod-tile { background: #1a1a1a; border: 1px solid #333; border-radius: 6px; padding: 12px 15px; margin-bottom: 8px; display: flex; justify-content: space-between; cursor: pointer; }
        .prod-tile:hover { background: #222; border-right: 4px solid var(--accent); }
        .cart-item-row { display: flex; justify-content: space-between; align-items: center; background: #111; padding: 10px; border-radius: 5px; margin-bottom: 5px; border: 1px solid #333; }
        .cart-del-btn { color: #555; cursor: pointer; font-size: 18px; } .cart-del-btn:hover { color: var(--danger); }
        
        .tab-chip { padding: 4px 10px; border-radius: 4px; background: #1a1a1a; border: 1px solid #333; color: #888; cursor: pointer; font-size: 12px; font-weight: bold; white-space: nowrap; }
        .tab-chip.active { background: var(--accent); color: black; border-color: var(--accent); }
        .scrolling-tabs { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 10px; margin-bottom: 10px; }
        
        /* INVISIBILE DI DEFAULT, APPARE SOLO QUANDO SALVI SUL DATABASE */
        #save-blocker { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; cursor: wait; }
    </style>
</head>
<body class="bg-app-main">

    <!-- BLOCCA SCHERMO DURANTE I SALVATAGGI PER EVITARE DOPPI CLICK -->
    <div id="save-blocker"></div>

    <div class="top-header">
        <button class="icon-btn" onclick="toggleMenu()"><i class="bi bi-list"></i></button>
        <div class="header-title" id="page-title">MAGAZZINO</div>
        <div class="user-badge" id="user-badge">...</div>
    </div>

    <div id="sidebar-overlay" onclick="toggleMenu()"></div>
    <div id="sidebar">
        <div class="sidebar-top"><h2 style="margin:0; color:var(--accent); font-size:30px">MENU OFFICINA</h2></div>
        <div class="nav-links">
            <a onclick="nav('dashboard')" id="nav-dashboard"><i class="bi bi-box-seam"></i> Magazzino</a>
            <a onclick="nav('operations')" id="nav-operations"><i class="bi bi-arrow-left-right"></i> Operazioni</a>
            <a onclick="nav('dailylist')" id="nav-dailylist"><i class="bi bi-clipboard-check"></i> Lista Serale</a>
            
            <div class="admin-section hidden" id="admin-menu" style="border-top:1px solid #333; margin-top:10px; background:#0f0f0f">
                <div style="padding:15px 20px; color:#666; font-size:12px; font-weight:bold">CAPO OFFICINA</div>
                <a onclick="nav('admin-products')" id="nav-admin-products"><i class="bi bi-boxes"></i> Anagrafica Prodotti</a>
                <a onclick="nav('admin-movements-log')" id="nav-admin-movements-log"><i class="bi bi-table"></i> Storico Movimenti</a>
            </div>
        </div>
        <div style="padding: 20px; border-top: 1px solid #333;">
            <button class="btn-logout" onclick="logout()">DISCONNESSIONE</button>
        </div>
    </div>

    <div id="main-content">
        <div class="desktop-wrapper">
            
            <!-- DASHBOARD -->
            <div id="page-dashboard" class="page hidden">
                <div class="search-wrapper"><i class="bi bi-search"></i><input type="text" id="dash-search" class="dark-input" placeholder="Cerca prodotto..." onkeyup="renderDashboard()"></div>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <select id="dash-wh-filter" class="dark-select" onchange="renderDashboard()"></select>
                    <select id="dash-cat-filter" class="dark-select" onchange="renderDashboard()"></select>
                </div>
                <div id="dashboard-grid" class="grid-container"></div>
            </div>

            <!-- OPERATIONS -->
            <div id="page-operations" class="page hidden">
                <h3 style="color:var(--accent); margin-top:0;"><i class="bi bi-hammer"></i> REGISTRA MOVIMENTO</h3>
                
                <div style="background:#151515; padding:15px; border-radius:8px; border:1px solid #222; margin-bottom:15px;">
                    <select id="op-type-select" class="dark-input mb-3" style="border-left: 4px solid var(--accent);" onchange="updateOpTypeUI()">
                        <option value="CARICO">üü© ARRIVO MERCE (Carico)</option>
                        <option value="SCARICO_CUCINA">üü• SCARICO CUCINA (Uscite)</option>
                        <option value="SPOSTAMENTO">üü® SPOSTAMENTO INTERNO</option>
                        <option value="SCARTO">üóëÔ∏è SCARTO</option>
                        <option value="RETTIFICA">‚öôÔ∏è RETTIFICA INVENTARIO</option>
                    </select>
                    <div id="op-wh-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                        <div id="div-op-from"><label style="font-size:10px; color:#888;" id="lbl-from">DA MAGAZZINO:</label><select id="op-from-wh" class="dark-input"></select></div>
                        <div id="div-op-to"><label style="font-size:10px; color:#888;" id="lbl-to">VERSO MAGAZZINO:</label><select id="op-to-wh" class="dark-input"></select></div>
                    </div>
                </div>

                <div style="background:#151515; padding:15px; border-radius:8px; border:1px solid #222;">
                    <div class="search-wrapper mb-2"><i class="bi bi-search"></i><input type="text" id="op-search" class="dark-input search-tool" placeholder="Cerca prodotto..." onkeyup="renderOpSearch()"></div>
                    <div id="op-prod-list" style="max-height:280px; overflow-y:auto; padding:5px;"></div>
                </div>

                <div style="text-align:center; font-size:12px; color:var(--accent); margin-top:20px; font-weight:bold;">CODA OPERAZIONI</div>
                <div id="op-cart-list" style="min-height:80px; max-height:300px; overflow-y:auto; margin:10px 0; background:#1a1a1a; border-radius:8px; padding:10px;"></div>
                <button id="btn-confirm-op" class="btn-neon" onclick="submitOpMovements()" style="display:none;"><i class="bi bi-check-circle-fill"></i> CONFERMA E REGISTRA</button>
            </div>

            <!-- DAILY LIST -->
            <div id="page-dailylist" class="page hidden">
                <h3 style="margin-top:0;">LISTA SERALE OPERATIVA</h3>
                <div style="margin-bottom:15px;">
                    <label style="font-size:10px; color:#888;">MAGAZZINO DI RIFERIMENTO</label>
                    <select id="daily-wh" class="dark-select" onchange="renderDailyList(OP_ACTIVE_DEPT)"></select>
                </div>
                <div class="scrolling-tabs" id="dept-tabs"></div>
                <div id="daily-list-body" style="padding-bottom:80px"></div>
                <button class="btn-neon sticky" onclick="submitDaily()"><i class="bi bi-save"></i> SALVA E ALLINEA</button>
            </div>

            <!-- ADMIN LOG -->
            <div id="page-admin-movements-log" class="page hidden">
                <h3 style="margin-top:0;"><i class="bi bi-table"></i> REGISTRO MOVIMENTI</h3>
                <div style="overflow-x: auto; background: #111; border-radius: 8px; border: 1px solid #333;">
                    <table style="width: 100%; border-collapse: collapse; min-width: 600px; font-size:13px;">
                        <thead><tr style="background:#000; color:var(--accent); text-align:left;"><th style="padding:10px;">Data</th><th>Utente</th><th>Articolo</th><th>Tipo</th><th>Qt√†</th></tr></thead>
                        <tbody id="mov-log-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- ADMIN PRODOTTI -->
            <div id="page-admin-products" class="page hidden">
                <h3 style="margin-top:0;"><i class="bi bi-boxes"></i> GESTIONE PRODOTTI</h3>
                <div class="search-wrapper"><i class="bi bi-search"></i><input type="text" id="admin-prod-search" class="dark-input" placeholder="Cerca prodotto..." onkeyup="renderAdminProds()"></div>
                <div id="admin-prod-list"></div>
            </div>

        </div>
    </div>

    <!-- JAVASCRIPT GESTIONALE -->
    <script>
        const _sb = supabase.createClient(
            'https://jkekmxhrwwidkfoizhde.supabase.co', 
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImprZWtteGhyd3dpZGtmb2l6aGRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NjEwMTcsImV4cCI6MjA4NzAzNzAxN30.U_XxfpAR76Y7bhB_DdUu2CMeuIarR4158dgwITFRWAg'
        );

        let DB = { products: new Array(), warehouses: new Array(), inventory: {} };
        let OP_CART = new Array();
        let OP_ACTIVE_DEPT = 'GRIGLIA';
        let DAILY_DATA = {}; 
        
        function blockUI(block) {
            document.getElementById('save-blocker').style.display = block ? 'block' : 'none';
        }

        function logout() {
            localStorage.removeItem('cantiere_user');
            window.location.replace('index.html');
        }
        
        function renderQtyBadges(qty, prod) {
            if (!qty || qty <= 0) return '<span style="color:#666; font-size:12px; font-style:italic">0 pz</span>';
            let html = ''; let rem = qty;
            const pCrt = prod.Pezzi_per_Cartone || 1; const pPck = prod.Pezzi_per_Pacco || 1;
            
            if (pCrt > 1 && rem >= pCrt) { 
                const c = Math.floor(rem / pCrt); rem %= pCrt; 
                html += `<span class="unit-pill icon-box"><i class="bi bi-box-seam-fill"></i><b>${c}</b></span>`; 
            }
            if (pPck > 1 && rem >= pPck) { 
                const pk = Math.floor(rem / pPck); rem %= pPck; 
                html += `<span class="unit-pill icon-pack"><i class="bi bi-archive-fill"></i><b>${pk}</b></span>`; 
            }
            if (rem > 0 || html === '') { 
                html += `<span class="unit-pill icon-piece"><i class="bi bi-gear-wide-connected"></i><b>${rem}</b></span>`; 
            }
            return html;
        }

        // AVVIO ISTANTANEO
        window.onload = () => {
            document.getElementById('user-badge').innerText = USER.username.toUpperCase();
            if (USER.role.toUpperCase() === 'ADMIN') {
                document.getElementById('admin-menu').classList.remove('hidden');
            }
            
            loadDataFromSupabase();
            nav('dashboard');
        };

        async function loadDataFromSupabase() {
            try {
                const { data: prods } = await _sb.from('prodotti').select('*').order('nome_prodotto');
                let newProds = new Array();
                for(let p of prods) {
                    newProds.push({
                        ID_Prodotto: p.id, Nome: p.nome_prodotto, Reparto: p.reparto || 'NESSUNO',
                        Categoria: p.reparto || 'NESSUNO', Fornitore: p.fornitore || '-',
                        Pezzi_per_Cartone: p.pezzi_per_cartone || 1, Pezzi_per_Pacco: p.pezzi_per_pacco || 1
                    });
                }
                DB.products = newProds;

                const { data: mags } = await _sb.from('magazzini').select('*').order('nome');
                DB.warehouses = mags;

                const { data: giac } = await _sb.from('giacenze').select('*');
                DB.inventory = {};
                for (let g of giac) {
                    if (!DB.inventory) DB.inventory = {};
                    DB.inventory = g.quantita_totale_pezzi;
                }

                updateSelectFilters();
                // Ricarico la view attiva per aggiornare i numeri
                renderDashboard();
            } catch (e) {
                console.error("Sync Error:", e);
            }
        }

        function updateSelectFilters() {
            let whOpts = '';
            for (let w of DB.warehouses) whOpts += `<option value="${w.id}">${w.nome}</option>`;
            
            document.getElementById('dash-wh-filter').innerHTML = '<option value="ALL">TOTALE OFFICINA</option>' + whOpts;
            
            let catArray = new Array();
            for (let p of DB.products) {
                if(p.Categoria && !catArray.includes(p.Categoria) && p.Categoria !== 'NESSUNO') catArray.push(p.Categoria);
            }
            catArray.sort();
            
            let catOpts = '<option value="ALL">TUTTE LE CATEGORIE</option>';
            for (let c of catArray) catOpts += `<option value="${c}">${c}</option>`;
            document.getElementById('dash-cat-filter').innerHTML = catOpts;

            document.getElementById('op-from-wh').innerHTML = whOpts;
            document.getElementById('op-to-wh').innerHTML = whOpts;
            document.getElementById('daily-wh').innerHTML = whOpts;
        }

        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('sidebar-overlay').classList.toggle('active');
        }

        function nav(page) {
            document.querySelectorAll('.page').forEach(e => e.classList.add('hidden'));
            document.querySelectorAll('.nav-links a').forEach(e => e.classList.remove('active'));
            document.getElementById('page-' + page).classList.remove('hidden');
            
            const activeBtn = document.getElementById('nav-' + page);
            if (activeBtn) activeBtn.classList.add('active');
            
            const titles = { 'dashboard': 'MAGAZZINO', 'operations': 'OPERAZIONI', 'dailylist': 'LISTA SERALE', 'admin-products': 'PRODOTTI', 'admin-movements-log': 'REGISTRO MOVIMENTI'};
            document.getElementById('page-title').innerText = titles || page.toUpperCase();
            
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebar-overlay').classList.remove('active');

            if(page === 'dashboard') renderDashboard();
            if(page === 'operations') { OP_CART = new Array(); renderOpCart(); updateOpTypeUI(); }
            if(page === 'dailylist') renderDailyList('GRIGLIA');
            if(page === 'admin-products') renderAdminProds();
            if(page === 'admin-movements-log') loadMovementsLog();
        }

        function renderDashboard() {
            const q = document.getElementById('dash-search').value.toLowerCase();
            const wh = document.getElementById('dash-wh-filter').value;
            const cat = document.getElementById('dash-cat-filter').value;
            const grid = document.getElementById('dashboard-grid');
            grid.innerHTML = '';

            for (let p of DB.products) {
                if (q && p.Nome.toLowerCase().indexOf(q) === -1) continue;
                if (cat !== 'ALL' && p.Categoria !== cat) continue;

                let total = 0;
                let prodInv = DB.inventory || {};
                
                if (wh === 'ALL') { 
                    for (let mId in prodInv) total += prodInv; 
                } else { 
                    total = prodInv || 0; 
                }

                grid.innerHTML += `
                    <div class="card-item">
                        <h4 style="color:var(--accent); margin:0;">${p.Nome}</h4>
                        <div style="font-size:10px; color:#888">${p.Categoria}</div>
                        <div style="margin-top:8px;">${renderQtyBadges(total, p)}</div>
                        <div style="font-family:'Teko'; font-size:22px; margin-top:5px; border-top:1px solid #333; color:#ccc;">${total} <span style="font-size:12px;">pz</span></div>
                    </div>`;
            }
        }

        function updateOpTypeUI() {
            const t = document.getElementById('op-type-select').value;
            const dFrom = document.getElementById('div-op-from');
            const dTo = document.getElementById('div-op-to');
            const lTo = document.getElementById('lbl-to');
            const lFrom = document.getElementById('lbl-from');
            
            dFrom.style.display = 'block'; 
            dTo.style.display = 'block';
            lTo.innerText = "VERSO MAGAZZINO:";
            lFrom.innerText = "DA MAGAZZINO:";
            
            if (t === 'CARICO') { dFrom.style.display = 'none'; }
            if (t === 'SCARICO_CUCINA' || t === 'SCARTO') { dTo.style.display = 'none'; }
            if (t === 'RETTIFICA') { dFrom.style.display = 'none'; lTo.innerText = "MAGAZZINO DA RETTIFICARE:"; }
            
            renderOpSearch();
        }

        function renderOpSearch() {
            const q = document.getElementById('op-search').value.toLowerCase();
            const div = document.getElementById('op-prod-list'); 
            div.innerHTML = '';
            
            let count = 0;
            for (let p of DB.products) {
                if (count > 30) break;
                if (!q || p.Nome.toLowerCase().indexOf(q) !== -1) {
                    div.innerHTML += `<div class="prod-tile" onclick="openQtyPopup('${p.ID_Prodotto}', 'OP')"><b>${p.Nome}</b><i class="bi bi-chevron-right"></i></div>`;
                    count++;
                }
            }
        }

        function openQtyPopup(pId, context) {
            let p = DB.products.find(x => x.ID_Prodotto === pId);
            if (!p) return;

            window.tempP = p;
            Swal.fire({
                title: p.Nome,
                html: `
                <div class="swal-grid">
                    <div class="swal-field"><label>CARTONI (x${p.Pezzi_per_Cartone})</label><input id="s-c" type="number" min="0" value="0" oninput="uPT()"></div>
                    <div class="swal-field"><label>PACCHI (x${p.Pezzi_per_Pacco})</label><input id="s-pk" type="number" min="0" value="0" oninput="uPT()"></div>
                    <div class="swal-field"><label>SFUSI</label><input id="s-ps" type="number" min="0" value="0" oninput="uPT()"></div>
                </div>
                <div style="margin-top:15px; font-family:'Teko'; font-size:26px; color:var(--accent)">Totale: <b id="s-t">0</b> pz</div>`,
                showCancelButton: true, confirmButtonText: 'AGGIUNGI', background: '#111', color: '#fff',
                preConfirm: () => {
                    const c = parseInt(document.getElementById('s-c').value||0);
                    const pk = parseInt(document.getElementById('s-pk').value||0);
                    const ps = parseInt(document.getElementById('s-ps').value||0);
                    return (c * p.Pezzi_per_Cartone) + (pk * p.Pezzi_per_Pacco) + ps;
                }
            }).then(res => {
                if (res.isConfirmed && res.value >= 0) { 
                    if (context === 'OP' && res.value > 0) addToOpCart(p, res.value);
                    if (context === 'DAILY') { DAILY_DATA = res.value; renderDailyList(OP_ACTIVE_DEPT); }
                }
            });
        }
        
        function uPT() {
            const p = window.tempP;
            const c = parseInt(document.getElementById('s-c').value||0) * p.Pezzi_per_Cartone;
            const pk = parseInt(document.getElementById('s-pk').value||0) * p.Pezzi_per_Pacco;
            const ps = parseInt(document.getElementById('s-ps').value||0);
            document.getElementById('s-t').innerText = c + pk + ps;
        }

        function addToOpCart(p, totPz) {
            const t = document.getElementById('op-type-select').value;
            const f = document.getElementById('op-from-wh').value;
            const to = document.getElementById('op-to-wh').value;
            
            let fWh = DB.warehouses.find(w => w.id === f);
            let tWh = DB.warehouses.find(w => w.id === to);
            let fName = fWh ? fWh.nome : "Sconosciuto";
            let tName = tWh ? tWh.nome : "Sconosciuto";

            OP_CART.push({ p: p, tot: totPz, type: t, fromId: f, toId: to, fromName: fName, toName: tName });
            renderOpCart();
        }

        function renderOpCart() {
            const div = document.getElementById('op-cart-list');
            const btn = document.getElementById('btn-confirm-op');
            div.innerHTML = OP_CART.length ? '' : '<div style="color:#666; text-align:center;">Nessuna operazione in coda</div>';
            btn.style.display = OP_CART.length ? 'block' : 'none';

            let i = 0;
            for (let it of OP_CART) {
                let path = '';
                if(it.type === 'CARICO') path = `IN -> ${it.toName}`;
                else if(it.type === 'SCARICO_CUCINA' || it.type === 'SCARTO') path = `${it.fromName} -> OUT`;
                else if(it.type === 'RETTIFICA') path = `OVERRIDE -> ${it.toName}`;
                else path = `${it.fromName} -> ${it.toName}`;

                div.innerHTML += `
                <div class="cart-item-row">
                    <div>
                        <b style="color:white;">${it.p.Nome}</b><br>
                        <span style="font-size:10px; padding:2px 6px; background:#222; border:1px solid #444; border-radius:4px; color:var(--accent)">${it.type}</span> 
                        <span style="font-size:11px; color:#aaa; margin-left:5px;">${path}</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:15px;">
                        <b style="font-size:18px; color:var(--accent)">${it.tot} pz</b>
                        <i class="bi bi-trash" style="color:var(--danger); cursor:pointer;" onclick="OP_CART.splice(${i},1); renderOpCart()"></i>
                    </div>
                </div>`;
                i++;
            }
        }

        async function submitOpMovements() {
            if(!OP_CART.length) return;
            blockUI(true);
            try {
                for (let item of OP_CART) {
                    let pId = item.p.ID_Prodotto;
                    
                    if (item.type === 'CARICO') {
                        await _updateGiacenza(pId, item.toId, item.tot, true);
                        await _logMovimento(pId, item.toId, 'CARICO', item.tot, 'Carico da fornitore');
                    } else if (item.type === 'SCARICO_CUCINA' || item.type === 'SCARTO') {
                        await _updateGiacenza(pId, item.fromId, -item.tot, true);
                        await _logMovimento(pId, item.fromId, item.type, item.tot, item.type);
                    } else if (item.type === 'SPOSTAMENTO') {
                        await _updateGiacenza(pId, item.fromId, -item.tot, true);
                        await _updateGiacenza(pId, item.toId, item.tot, true);
                        await _logMovimento(pId, item.fromId, 'SPOSTAMENTO', -item.tot, 'Uscita verso ' + item.toName);
                        await _logMovimento(pId, item.toId, 'SPOSTAMENTO', item.tot, 'Entrata da ' + item.fromName);
                    } else if (item.type === 'RETTIFICA') {
                        await _updateGiacenza(pId, item.toId, item.tot, false);
                        await _logMovimento(pId, item.toId, 'RETTIFICA', item.tot, 'Rettifica manuale admin');
                    }
                }
                Swal.fire({ icon: 'success', title: 'OPERAZIONI REGISTRATE', background: '#111', color: '#fff', timer: 1500, showConfirmButton:false });
                OP_CART = new Array(); 
                renderOpCart();
                await loadDataFromSupabase(); 
            } catch(e) {
                Swal.fire({ icon: 'error', title: 'Errore Server', text: e.message, background: '#111', color: '#fff' });
            } finally {
                blockUI(false);
            }
        }

        async function _updateGiacenza(pId, mId, delta, isRelative) {
            const { data: es } = await _sb.from('giacenze').select('*').eq('prodotto_id', pId).eq('magazzino_id', mId).maybeSingle();
            const oldVal = es ? es.quantita_totale_pezzi : 0;
            const newVal = isRelative ? oldVal + delta : delta;
            
            if (es) {
                await _sb.from('giacenze').update({ quantita_totale_pezzi: newVal, aggiornato_il: new Date() }).eq('id', es.id);
            } else {
                await _sb.from('giacenze').insert({ prodotto_id: pId, magazzino_id: mId, quantita_totale_pezzi: newVal });
            }
        }

        async function _logMovimento(pId, mId, tipo, qta, causale) {
            await _sb.from('movimenti').insert({ utente_id: USER.id, prodotto_id: pId, magazzino_id: mId, tipo_movimento: tipo, quantita_pezzi: qta, causale: causale });
        }

        function renderDailyList(dept) {
            OP_ACTIVE_DEPT = dept;
            
            let repArray = new Array();
            for (let p of DB.products) {
                if(p.Reparto && !repArray.includes(p.Reparto) && p.Reparto !== 'NESSUNO') repArray.push(p.Reparto);
            }
            if(repArray.length === 0) repArray.push(dept);

            let htmlTabs = '';
            for (let d of repArray) {
                htmlTabs += `<div class="tab-chip ${d === dept ? 'active' : ''}" onclick="renderDailyList('${d}')">${d}</div>`;
            }
            document.getElementById('dept-tabs').innerHTML = htmlTabs;
            
            const div = document.getElementById('daily-list-body'); 
            div.innerHTML = '';
            const wh = document.getElementById('daily-wh').value;

            for (let p of DB.products) {
                if (p.Reparto !== dept) continue;

                let entered = DAILY_DATA;
                let prodInv = DB.inventory || {};
                let invTeorico = prodInv || 0;
                
                let valHtml = (entered !== undefined && entered !== null) ? 
                    `<b style="color:var(--accent); font-size:18px">${entered} pz</b>` : 
                    `<span style="color:#666; font-size:12px">Teorico: ${invTeorico}</span>`;

                div.innerHTML += `
                    <div style="background:#1a1a1a; padding:12px; margin-bottom:8px; border-radius:6px; border:1px solid #333; display:flex; justify-content:space-between; cursor:pointer;" onclick="openQtyPopup('${p.ID_Prodotto}', 'DAILY')">
                        <div><b style="color:white;">${p.Nome}</b><br><small style="color:#888">${p.Categoria}</small></div>
                        <div style="display:flex; align-items:center;">${valHtml}</div>
                    </div>`;
            }
        }

        async function submitDaily() {
            let pIds = Object.keys(DAILY_DATA);
            if(pIds.length === 0) return Swal.fire({ icon: 'info', title: 'Nessun Dati', text: 'Nessun conteggio inserito.', background: '#111', color: '#fff' });
            
            const whId = document.getElementById('daily-wh').value;
            if(!whId) return Swal.fire({ icon: 'error', title: 'Errore', text: 'Seleziona un magazzino valido.', background: '#111', color: '#fff' });

            blockUI(true);
            try {
                for (let pId of pIds) {
                    let contato = DAILY_DATA;
                    let prodInv = DB.inventory || {};
                    let teorico = prodInv || 0;
                    
                    await _sb.from('liste_serali').insert({ reparto: OP_ACTIVE_DEPT, utente_id: USER.id, prodotto_id: pId, quantita_contata_pezzi: contato, note: 'Check list serale' });
                    
                    if (contato !== teorico) {
                        await _updateGiacenza(pId, whId, contato, false);
                        await _logMovimento(pId, whId, 'RETTIFICA', contato, 'Rettifica da Check Serale (Teorico: '+teorico+')');
                    }
                }
                
                DAILY_DATA = {}; 
                await loadDataFromSupabase(); 
                renderDailyList(OP_ACTIVE_DEPT); 
                Swal.fire({ icon: 'success', title: 'Allineamento Completato', background: '#111', color: '#fff', timer: 1500, showConfirmButton:false });
            } catch(e) {
                Swal.fire({ icon: 'error', title: 'Errore', text: e.message, background: '#111', color: '#fff' });
            } finally {
                blockUI(false);
            }
        }

        async function loadMovementsLog() {
            try {
                const { data } = await _sb.from('movimenti').select('*, prodotti(nome_prodotto), utenti_app(username), magazzini(nome)').order('data_ora', {ascending: false}).limit(50);
                const tbody = document.getElementById('mov-log-body');
                let html = '';
                for (let m of data) {
                    let color = m.tipo_movimento.includes('SCARICO') ? 'color:var(--danger)' : (m.tipo_movimento === 'CARICO' ? 'color:#2ecc71' : 'color:var(--accent)');
                    
                    html += `<tr style="border-bottom: 1px solid #222;">
                        <td style="padding:10px; font-size:11px; color:#888;">${new Date(m.data_ora).toLocaleString('it-IT').slice(0,16)}</td>
                        <td style="color:white; font-size:12px;">${m.utenti_app ? m.utenti_app.username.toUpperCase() : 'SISTEMA'}</td>
                        <td>
                            <b style="color:white;">${m.prodotti ? m.prodotti.nome_prodotto : 'Sconosciuto'}</b><br>
                            <span style="font-size:10px; color:#666">Mag: ${m.magazzini ? m.magazzini.nome : '-'}</span>
                        </td>
                        <td style="${color}; font-weight:bold; font-size:11px;">${m.tipo_movimento}</td>
                        <td style="color:white; font-weight:bold;">${m.quantita_pezzi}</td>
                    </tr>`;
                }
                tbody.innerHTML = html;
            } catch(e) {
                console.error(e);
            }
        }

        function renderAdminProds() {
            const q = document.getElementById('admin-prod-search').value.toLowerCase();
            const div = document.getElementById('admin-prod-list');
            let html = '';
            for (let p of DB.products) {
                if (q && p.Nome.toLowerCase().indexOf(q) === -1) continue;
                html += `
                <div style="background:#1a1a1a; padding:12px; margin-bottom:8px; border-radius:6px; border:1px solid #333; display:flex; justify-content:space-between;">
                    <div><b style="color:var(--accent);">${p.Nome}</b><br><span style="font-size:11px; color:#888;">Reparto: ${p.Reparto}</span></div>
                    <div style="text-align:right; font-size:11px; color:#666;">1 CT = ${p.Pezzi_per_Cartone} pz<br>1 PK = ${p.Pezzi_per_Pacco} pz</div>
                </div>`;
            }
            div.innerHTML = html;
        }
    </script>
</body>
</html>
