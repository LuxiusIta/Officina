<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cantiere | Professional Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        :root { --gold: #ffc107; --dark: #050505; --card-bg: #111111; --border: #222222; }
        
        body { background-color: var(--dark); color: #e0e0e0; font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR PROFESSIONAL */
        .sidebar { width: 280px; background: #000; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 30px 20px; flex-shrink: 0; z-index: 100; }
        .sidebar h2 { font-weight: 900; color: var(--gold); letter-spacing: -1px; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        
        .nav-link-c { padding: 15px 20px; border-radius: 12px; cursor: pointer; font-weight: 700; color: #666; display: flex; align-items: center; gap: 15px; transition: 0.3s; text-transform: uppercase; font-size: 0.85rem; margin-bottom: 5px; }
        .nav-link-c:hover { background: #111; color: #fff; }
        .nav-link-c.active { background: var(--gold); color: #000; box-shadow: 0 10px 20px rgba(255,193,7,0.2); }

        /* MAIN CONTENT */
        .main-wrapper { flex: 1; overflow-y: auto; padding: 40px; position: relative; }
        .view { display: none; max-width: 1400px; margin: 0 auto; }
        .view.active { display: block; animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS & STORAGE BOXES */
        .storage-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 24px; padding: 25px; transition: 0.3s; position: relative; overflow: hidden; }
        .storage-card:hover { border-color: var(--gold); transform: translateY(-5px); }
        .total-badge { position: absolute; top: 20px; right: 20px; background: var(--gold); color: #000; font-weight: 900; padding: 5px 12px; border-radius: 8px; font-size: 0.9rem; }
        
        /* INPUT STYLE */
        .c-input { background: #1a1a1a !important; border: 1px solid #333 !important; color: #fff !important; border-radius: 12px !important; padding: 15px !important; }
        .c-input:focus { border-color: var(--gold) !important; box-shadow: none !important; }

        /* CHAT */
        #chat-window { position: fixed; bottom: 100px; right: 30px; width: 400px; height: 600px; background: #000; border: 1px solid var(--gold); border-radius: 24px; display: none; flex-direction: column; box-shadow: 0 30px 60px rgba(0,0,0,0.8); z-index: 2000; }
        .chat-bubble { padding: 12px 18px; border-radius: 18px; font-size: 0.9rem; max-width: 80%; margin-bottom: 5px; }
        .bubble-me { background: var(--gold); color: #000; align-self: flex-end; font-weight: 700; }
        .bubble-them { background: #222; color: #fff; align-self: flex-start; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { width: 100%; height: auto; padding: 15px; border-right: none; border-bottom: 1px solid var(--border); }
            .nav-link-c { display: none; } /* Su mobile usiamo il menu a icone se necessario */
        }
    </style>
</head>
<body>
<div class="sidebar">
    <h2><i class="bi bi-cone-striped"></i> CANTIERE</h2>
    <div class="nav-link-c active" id="btn-dash" onclick="showV('v-dash', 'btn-dash')"><i class="bi bi-stack"></i> Magazzini</div>
    <div class="nav-link-c" id="btn-mov" onclick="showV('v-mov', 'btn-mov')"><i class="bi bi-arrow-down-up"></i> Movimenti</div>
    <div class="nav-link-c" id="btn-sto" onclick="showV('v-sto', 'btn-sto')"><i class="bi bi-calendar3"></i> Storico</div>
    <div class="nav-link-c" id="btn-prod" onclick="showV('v-prod', 'btn-prod')"><i class="bi bi-tags"></i> Prodotti</div>
    <div class="nav-link-c admin-only" id="btn-adm" onclick="showV('v-adm', 'btn-adm')"><i class="bi bi-shield-lock"></i> Admin</div>
    
    <div class="mt-auto p-3 bg-dark rounded-4">
        <small class="text-secondary d-block">USER ACTIVE</small>
        <b id="user-name" class="text-white">...</b>
        <button class="btn btn-link btn-sm text-danger p-0 d-block mt-2" onclick="logout()">LOGOUT</button>
    </div>
</div>

<div class="main-wrapper">
    <div id="v-dash" class="view active">
        <h1 class="fw-black mb-4">LOGISTICA <span class="text-warning">CANTIERE</span></h1>
        <div id="magazzini-grid" class="row g-4"></div>
    </div>

    <div id="v-det" class="view">
        <div class="d-flex justify-content-between align-items-end mb-5">
            <div><h1 id="det-title" class="text-warning fw-black mb-0"></h1><p class="text-secondary">Analisi scorte in tempo reale</p></div>
            <button class="btn btn-outline-light rounded-pill px-4" onclick="showV('v-dash', 'btn-dash')">CHIUDI AREA</button>
        </div>
        <div id="prodotti-list"></div>
    </div>

    <div id="v-mov" class="view">
        <div class="row justify-content-center"><div class="col-lg-8"><div class="storage-card p-5">
            <h2 class="fw-black text-center mb-5"><i class="bi bi-node-plus text-warning"></i> NUOVO MOVIMENTO</h2>
            <div class="row g-3">
                <div class="col-md-6"><label class="small fw-bold">PRODOTTO</label><select id="mov-prod" class="form-select c-input"></select></div>
                <div class="col-md-6"><label class="small fw-bold">DESTINAZIONE</label><select id="mov-maga" class="form-select c-input"></select></div>
            </div>
            <div class="row g-4 mt-4">
                <div class="col-4 text-center">
                    <i class="bi bi-box-seam fs-2 text-warning"></i><br>
                    <label class="small fw-bold mt-2">CARTONI</label>
                    <input type="number" id="in-ct" class="form-control c-input text-center fs-4" value="0">
                </div>
                <div class="col-4 text-center">
                    <i class="bi bi-box fs-2 text-warning"></i><br>
                    <label class="small fw-bold mt-2">PACCHI</label>
                    <input type="number" id="in-pk" class="form-control c-input text-center fs-4" value="0">
                </div>
                <div class="col-4 text-center">
                    <i class="bi bi-hammer fs-2 text-warning"></i><br>
                    <label class="small fw-bold mt-2">SFUSI</label>
                    <input type="number" id="in-pz" class="form-control c-input text-center fs-4" value="0">
                </div>
            </div>
            <div class="row g-3 mt-5">
                <div class="col-6"><button onclick="registra('CARICO')" class="btn btn-success w-100 py-3 fw-black">CARICA (+)</button></div>
                <div class="col-6"><button onclick="registra('SCARICO')" class="btn btn-danger w-100 py-3 fw-black">SCARICA (-)</button></div>
            </div>
        </div></div></div>
    </div>

    <div id="v-sto" class="view">
        <h1 class="fw-black mb-4 text-warning">STORICO OPERAZIONI</h1>
        <div class="storage-card p-0 overflow-hidden"><table class="table table-dark table-hover mb-0">
            <thead class="bg-black"><tr><th class="p-3">DATA</th><th>UTENTE</th><th>ARTICOLO</th><th>TIPO</th><th class="text-end p-3">TOTALE PEZZI</th></tr></thead>
            <tbody id="sto-body"></tbody>
        </table></div>
    </div>
</div>

<div id="chat-trigger" onclick="toggleChat()" style="position:fixed; bottom:30px; right:30px; width:70px; height:70px; background:var(--gold); border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:2rem; color:#000; box-shadow:0 10px 30px rgba(255,193,7,0.4);"><i class="bi bi-chat-dots-fill"></i></div>
<div id="chat-window">
    <div class="p-3 border-bottom border-secondary d-flex justify-content-between align-items-center bg-dark">
        <b class="text-warning">RADIO COMUNICAZIONI</b>
        <button class="btn-close btn-close-white" onclick="toggleChat()"></button>
    </div>
    <div id="chat-body" class="p-3 d-flex flex-column overflow-auto" style="flex:1;"></div>
    <div class="p-3 border-top border-secondary bg-dark">
        <div class="input-group"><input type="text" id="chat-in" class="form-control c-input" placeholder="Parla col cantiere..."><button class="btn btn-warning" onclick="sendMsg()"><i class="bi bi-send"></i></button></div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const _sb = supabase.createClient("https://jkekmxhrwwidkfoizhde.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImprZWtteGhyd3dpZGtmb2l6aGRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NjEwMTcsImV4cCI6MjA4NzAzNzAxN30.U_XxfpAR76Y7bhB_DdUu2CMeuIarR4158dgwITFRWAg");
    const session = JSON.parse(localStorage.getItem('cantiere_user'));
    if(!session) window.location.replace('index.html');
    document.getElementById('user-name').innerText = session.username.toUpperCase();
    if(session.ruolo === 'admin') document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'flex');

    function showV(id, bId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.nav-link-c').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(bId) document.getElementById(bId).classList.add('active');
        if(id === 'v-dash') loadMagazzini();
        if(id === 'v-mov') loadMovimentData();
        if(id === 'v-sto') loadStorico();
    }

    // LOGICA DI CALCOLO UNITA' (Dall'originale Google Script)
    function calculateUnits(total, p) {
        const ct = Math.floor(total / p.pezzi_per_cartone);
        const rem = total % p.pezzi_per_cartone;
        const pk = Math.floor(rem / p.pezzi_per_pacco);
        const pz = rem % p.pezzi_per_pacco;
        return { ct, pk, pz };
    }

    async function loadMagazzini() {
        const { data: magazzini } = await _sb.from('magazzini').select('*').order('nome');
        const { data: giacenze } = await _sb.from('giacenze').select('quantita_totale_pezzi');
        
        document.getElementById('magazzini-grid').innerHTML = magazzini.map(m => `
            <div class="col-md-4"><div class="storage-card" onclick="openMaga('${m.id}', '${m.nome}')">
                <i class="bi bi-box-seam-fill text-warning fs-1"></i>
                <h4 class="mt-3 fw-black">${m.nome}</h4>
                <small class="text-secondary">Gestione scorte e giacenze</small>
            </div></div>`).join('');
    }

    async function openMaga(id, nome) {
        document.getElementById('det-title').innerText = nome;
        const { data } = await _sb.from('giacenze').select('*, prodotti(*)').eq('magazzino_id', id);
        
        document.getElementById('prodotti-list').innerHTML = data.map(g => {
            const units = calculateUnits(g.quantita_totale_pezzi, g.prodotti);
            return `
            <div class="storage-card mb-3">
                <div class="total-badge">${g.quantita_totale_pezzi} PZ TOTALI</div>
                <h4 class="fw-black text-warning">${g.prodotti.nome_prodotto}</h4>
                <div class="row mt-3 text-center">
                    <div class="col-4 border-end border-secondary">
                        <i class="bi bi-box-seam d-block opacity-50"></i><b>${units.ct}</b><br><small>CARTONI</small>
                    </div>
                    <div class="col-4 border-end border-secondary">
                        <i class="bi bi-box d-block opacity-50"></i><b>${units.pk}</b><br><small>PACCHI</small>
                    </div>
                    <div class="col-4">
                        <i class="bi bi-hammer d-block opacity-50"></i><b>${units.pz}</b><br><small>SFUSI</small>
                    </div>
                </div>
            </div>`;
        }).join('');
        showV('v-det');
    }

    async function registra(tipo) {
        const pId = document.getElementById('mov-prod').value;
        const mId = document.getElementById('mov-maga').value;
        const { data: prod } = await _sb.from('prodotti').select('*').eq('id', pId).single();
        
        const tot = (parseInt(document.getElementById('in-ct').value) * prod.pezzi_per_cartone) +
                    (parseInt(document.getElementById('in-pk').value) * prod.pezzi_per_pacco) +
                    parseInt(document.getElementById('in-pz').value);
        
        if(tot <= 0) return Swal.fire({ icon: 'error', title: 'ALT!', text: 'Inserisci quantitÃ  valide', background: '#111', color: '#fff' });

        const { data: es } = await _sb.from('giacenze').select('*').eq('prodotto_id', pId).eq('magazzino_id', mId).maybeSingle();
        const nQ = es ? (tipo === 'CARICO' ? es.quantita_totale_pezzi + tot : es.quantita_totale_pezzi - tot) : (tipo === 'CARICO' ? tot : -tot);

        await _sb.from('giacenze').upsert({ id: es?.id, prodotto_id: pId, magazzino_id: mId, quantita_totale_pezzi: nQ });
        await _sb.from('movimenti').insert([{ prodotto_id: pId, magazzino_id: mId, tipo_movimento: tipo, quantita_pezzi: tot, utente_id: session.id }]);
        
        Swal.fire({ icon: 'success', title: 'OPERAZIONE REGISTRATA', toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
        showV('v-dash', 'btn-dash');
    }

    async function loadStorico() {
        const { data } = await _sb.from('movimenti').select('*, prodotti(nome_prodotto), utenti_app(username)').order('data_movimento', {ascending: false});
        document.getElementById('sto-body').innerHTML = data.map(m => `
            <tr>
                <td class="p-3 opacity-50 small">${new Date(m.data_movimento).toLocaleString()}</td>
                <td class="fw-bold">${m.utenti_app.username.toUpperCase()}</td>
                <td>${m.prodotti.nome_prodotto}</td>
                <td><span class="badge ${m.tipo_movimento === 'CARICO' ? 'bg-success text-dark' : 'bg-danger'}">${m.tipo_movimento}</span></td>
                <td class="text-end fw-black text-warning p-3">${m.quantita_pezzi} PZ</td>
            </tr>`).join('');
    }

    async function loadMovimentData() {
        const { data: p } = await _sb.from('prodotti').select('*');
        const { data: m } = await _sb.from('magazzini').select('*');
        document.getElementById('mov-prod').innerHTML = p.map(x => `<option value="${x.id}">${x.nome_prodotto}</option>`).join('');
        document.getElementById('mov-maga').innerHTML = m.map(x => `<option value="${x.id}">${x.nome}</option>`).join('');
    }

    function toggleChat() { 
        const w = document.getElementById('chat-window'); 
        w.style.display = w.style.display === 'flex' ? 'none' : 'flex'; 
        if(w.style.display === 'flex') loadChat();
    }

    function logout() { localStorage.clear(); window.location.replace('index.html'); }
    loadMagazzini();
</script>
</body>
</html>
