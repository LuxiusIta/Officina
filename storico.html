<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cantiere | Storico Movimenti</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --cantiere-gold: #ffc107; --cantiere-dark: #121212; --cantiere-card: #1e1e1e; }
        body { background-color: var(--cantiere-dark); color: #fff; font-family: 'Inter', sans-serif; }
        .navbar { background: #000; border-bottom: 2px solid var(--cantiere-gold); }
        .table-cantiere { background: var(--cantiere-card); border-radius: 12px; overflow: hidden; border: 1px solid #333; }
        .table-cantiere th { background: #000; color: var(--cantiere-gold); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; padding: 15px; }
        .table-cantiere td { padding: 15px; border-bottom: 1px solid #2a2a2a; vertical-align: middle; }
        .badge-carico { background: #28a745; color: #fff; font-weight: 800; padding: 5px 10px; border-radius: 4px; font-size: 0.7rem; }
        .badge-scarico { background: #dc3545; color: #fff; font-weight: 800; padding: 5px 10px; border-radius: 4px; font-size: 0.7rem; }
        .user-tag { color: var(--cantiere-gold); font-weight: 600; font-size: 0.9rem; }
    </style>
</head>
<body>

<nav class="navbar p-3">
    <div class="container-fluid">
        <a href="dashboard.html" class="text-white text-decoration-none fw-bold"><i class="bi bi-arrow-left me-2"></i> TORNA ALLA DASHBOARD</a>
        <span class="text-warning fw-bold">REGISTRO MOVIMENTI</span>
    </div>
</nav>

<div class="container mt-4">
    <div class="table-responsive">
        <table class="table table-dark table-cantiere">
            <thead>
                <tr>
                    <th>Data / Ora</th>
                    <th>Operatore</th>
                    <th>Operazione</th>
                    <th>Prodotto</th>
                    <th>Magazzino</th>
                    <th class="text-end">Pezzi Totali</th>
                </tr>
            </thead>
            <tbody id="storico-body">
                </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // IL BUTTAFUORI
    if (!localStorage.getItem('cantiere_user')) { location.href = "index.html"; }

    const _supabase = supabase.createClient("https://jkekmxhrwwidkfoizhde.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImprZWtteGhyd3dpZGtmb2l6aGRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NjEwMTcsImV4cCI6MjA4NzAzNzAxN30.U_XxfpAR76Y7bhB_DdUu2CMeuIarR4158dgwITFRWAg");

    async function caricaStorico() {
        const { data, error } = await _supabase
            .from('movimenti')
            .select('*, prodotti(nome_prodotto), magazzini(nome), utenti_app(username)')
            .order('data_movimento', { ascending: false });

        if (error) {
            console.error(error);
            return;
        }

        const tbody = document.getElementById('storico-body');
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-secondary p-5">Nessun movimento registrato.</td></tr>';
            return;
        }

        tbody.innerHTML = data.map(m => {
            const dataOra = new Date(m.data_movimento).toLocaleString('it-IT', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
            const badgeClass = m.tipo_movimento === 'CARICO' ? 'badge-carico' : 'badge-scarico';
            
            return `
                <tr>
                    <td class="small text-secondary">${dataOra}</td>
                    <td class="user-tag"><i class="bi bi-person-circle me-1"></i> ${m.utenti_app?.username || 'Sistema'}</td>
                    <td><span class="${badgeClass}">${m.tipo_movimento}</span></td>
                    <td class="fw-bold">${m.prodotti?.nome_prodotto || 'Eliminato'}</td>
                    <td><i class="bi bi-geo-alt text-secondary me-1"></i>${m.magazzini?.nome || 'N/D'}</td>
                    <td class="text-end fw-bold text-warning">${m.quantita_pezzi} PZ</td>
                </tr>
            `;
        }).join('');
    }

    // Aggiornamento Realtime se qualcuno muove merce mentre guardi lo storico
    _supabase.channel('storico-live').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'movimenti' }, () => caricaStorico()).subscribe();

    caricaStorico();
</script>
</body>
</html>
