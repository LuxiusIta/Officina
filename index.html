<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Cantiere Hambirreria</title>
    
    <!-- FONTS & ICONS -->
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- SWEETALERT2 -->
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>

    <!-- SUPABASE -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- PWA -->
    <meta name="apple-mobile-web-app-title" content="Cantiere">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://yt3.googleusercontent.com/ytc/AIdro_nC2KYqN62QVeGk8Fj8CAnW8dEJ4FNTgqqVC8dgSFaxgQ=s160-c-k-c0x00ffffff-no-rj">
    <link rel="icon" type="image/x-icon" href="https://yt3.googleusercontent.com/ytc/AIdro_nC2KYqN62QVeGk8Fj8CAnW8dEJ4FNTgqqVC8dgSFaxgQ=s160-c-k-c0x00ffffff-no-rj">

    <style>
        /* ========================================================
           CSS ORIGINALE DEL CANTIERE MANTENUTO INTATTO
           ======================================================== */
        :root {
            --bg-dark: #0a0a0a; --bg-panel: #1a1a1a; --accent: #FFD700;
            --text-main: #f0f0f0; --danger: #FF4444; --steel: #cfd8dc;
            --c-box: #D2691E; --c-pack: #00BFFF; --c-piece: #ffffff;
        }

        html, body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background: #0a0a0a; color: white; overflow-x: hidden; max-width: 100vw; -webkit-tap-highlight-color: transparent; }
        h1, h2, h3, h4, .brand-title { font-family: 'Teko', sans-serif; text-transform: uppercase; letter-spacing: 1px; }
        .hidden { display: none !important; }

        .sticky { position: fixed; bottom: 20px; left: 5%; width: 90%; max-width: 800px; z-index: 90; box-shadow: 0 5px 20px rgba(0,0,0,0.8); margin-left: auto; margin-right: auto; right: 5%; }
        .bg-steel-login { background: url('https://previews.123rf.com/images/wasansos1/wasansos11901/wasansos1190100009/133826034-background-of-the-surface-of-the-steel-plate.jpg') no-repeat center center fixed; background-size: cover; }
        .bg-app-main { background: url('https://i.imgur.com/f0y6jAe.jpeg') no-repeat center center fixed; background-size: cover; min-height: 100vh; background-attachment: fixed; }
        .vignette { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); pointer-events: none; z-index: 0; }

        #main-content { display: flex; justify-content: center; width: 100%; box-sizing: border-box; padding-top: 20px; position: relative; z-index: 1; }
        .desktop-wrapper { width: 100%; max-width: 900px; padding: 20px; box-sizing: border-box; background: #121212; border-radius: 8px; min-height: 90vh; border: 1px solid #333; box-shadow: 0 0 50px rgba(0,0,0,0.9); margin-bottom: 50px; }

        .top-header { height: 60px; background: #000; display: flex; align-items: center; padding: 0 15px; border-bottom: 2px solid var(--accent); position: sticky; top: 0; z-index: 100; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.8); }
        .header-title { font-family: 'Teko'; font-size: 28px; flex-grow: 1; color: white; margin-left: 15px; letter-spacing: 1px; }
        .user-badge { background: #222; padding: 5px 12px; border-radius: 4px; font-size: 14px; color: var(--accent); font-weight: bold; border: 1px solid #444; }
        .icon-btn { background: none; border: none; color: var(--accent); font-size: 26px; cursor: pointer; padding: 5px; }

        #sidebar { position: fixed; top: 0; left: -280px; width: 280px; height: 100vh; background: #000; z-index: 2000; transition: 0.3s; border-right: 2px solid var(--accent); display: flex; flex-direction: column; box-shadow: 10px 0 50px rgba(0,0,0,1); }
        #sidebar.active { left: 0; }
        #sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: rgba(0,0,0,0.8); z-index: 1999; display: none; backdrop-filter: blur(5px); }
        #sidebar-overlay.active { display: block; }
        .sidebar-top { padding: 30px 20px; background: #111; border-bottom: 1px solid #333; }
        .nav-links { overflow-y: auto; flex: 1; }
        .nav-links a { display: block; padding: 12px 15px; color: #ccc; text-decoration: none; border-left: 4px solid transparent; font-size: 15px; transition: 0.2s; border-bottom: 1px solid #1a1a1a; cursor: pointer;}
        .nav-links a i { width: 25px; text-align: center; color: var(--accent); margin-right: 10px; }
        .nav-links a.active { background: #1a1a1a; color: white; border-left-color: var(--accent); }
        .sidebar-footer { padding: 20px; border-top: 1px solid #333; }
        .btn-logout { width: 100%; padding: 12px; background: #111; color: var(--danger); border: 1px solid #333; cursor: pointer; font-weight: bold; font-family: 'Teko'; font-size: 20px; letter-spacing: 1px; }

        .btn-neon { background: var(--accent); color: #000; font-family: 'Teko'; font-size: 22px; border: none; padding: 12px; width: 100%; border-radius: 6px; font-weight: 700; letter-spacing: 1px; cursor: pointer; transition: 0.2s; text-transform: uppercase; }
        .btn-neon:hover { background: #e5c100; }
        .dark-input, .dark-select { background: #000; border: 1px solid #444; color: white; padding: 8px 12px; border-radius: 6px; width: 100%; box-sizing: border-box; text-align: center; font-size: 14px; height: 40px; }
        .dark-input:focus, .dark-select:focus { border-color: var(--accent); outline: none; }

        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; padding-bottom: 20px; }
        .card-item { background: #1e1e1e; border-radius: 8px; padding: 10px; border: 1px solid #333; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .card-item h4 { margin: 5px 0; color: white; font-size: 15px; }
        .total-row { color: var(--steel); font-family: 'Teko'; font-size: 22px; margin-top: 5px; border-top: 1px solid #444; padding-top: 5px; }

        .scrolling-tabs { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 10px; margin-bottom: 10px; }
        
        /* Modals & SweetAlert fixes */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 5000; backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        .modal-body { background: #111; margin: 20px auto; width: 95%; max-width: 500px; border-radius: 12px; padding: 25px; border: 1px solid var(--accent); max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 0 50px rgba(0,0,0,1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; font-size: 24px; color: var(--accent); font-family: 'Teko'; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .close-icon { font-size: 28px; cursor: pointer; color: white; }

        .unit-pill { display: inline-flex; align-items: center; gap: 4px; padding: 1px 5px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-right: 4px; border: 1px solid rgba(255,255,255,0.1); }
        .unit-pill b { font-family: 'Roboto', sans-serif; font-size: 12px; }
        .icon-box { background: rgba(210,105,30,0.15); color: #D2691E; border-color: #D2691E; }
        .icon-pack { background: rgba(0,191,255,0.15); color: #00BFFF; border-color: #00BFFF; }
        .icon-piece { background: rgba(255,255,255,0.1); color: #ffffff; border-color: #ffffff; }

        .search-wrapper { position: relative; margin-bottom: 15px; }
        .search-wrapper i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--accent); }
        .search-wrapper input { padding-left: 45px !important; text-align: left !important; background: #000; }
        .cat-header { background: #222; color: var(--accent); padding: 10px; font-weight: bold; font-size: 14px; border-bottom: 1px solid #444; position: sticky; top: 0; z-index: 5; text-transform: uppercase; border-left: 4px solid var(--accent); }

        #login-screen { height: 100vh; display: flex; align-items: center; justify-content: center; position: relative; z-index: 10; }
        .login-container { background: #111; padding: 40px 30px; border-radius: 10px; text-align: center; width: 90%; max-width: 380px; border: 2px solid var(--accent); position: relative; box-shadow: 0 0 60px rgba(0,0,0,1); z-index: 20; }
        .brand-stripe { height: 4px; background: var(--accent); position: absolute; top: 0; left: 0; width: 100%; }
        .logo-circle { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--accent); object-fit: cover; margin-bottom: 15px; background: #000; padding: 2px; }
        .brand-title { font-size: 40px; margin: 5px 0 25px; line-height: 1; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.8); }
        .input-wrap { background: #000; border: 1px solid #444; border-radius: 6px; margin-bottom: 15px; display: flex; align-items: center; padding: 0 10px; }
        .input-wrap i { color: var(--accent); padding: 0 10px; font-size: 18px; }
        .input-wrap input { background: transparent; border: none; color: white; padding: 15px 5px; width: 100%; font-size: 16px; outline: none; }

        .swal-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px; }
        .swal-field { display: flex; flex-direction: column; align-items: center; background: #000; padding: 10px 5px; border-radius: 6px; border: 1px solid #333; }
        .swal-field label { font-size: 10px; color: #888; margin-bottom: 5px; text-transform: uppercase; }
        .swal-field input { width: 50px; background: transparent; border: none; color: white; text-align: center; font-size: 22px; font-weight: bold; padding: 5px 2px; outline: none; }
        .stepper-btn { background: #222; border: 1px solid #444; color: var(--accent); width: 32px; height: 32px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 18px; user-select: none; }
        div:where(.swal2-container) div:where(.swal2-popup) { background: #151515 !important; border: 2px solid var(--accent) !important; box-shadow: 0 0 50px rgba(0,0,0,0.9); }

        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .loader-gear { font-size: 100px; color: #222; animation: spin 4s linear infinite; position: absolute; }
        .loader-wrench { font-size: 50px; color: var(--accent); position: absolute; animation: rock 2s ease-in-out infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes rock { 0% { transform: rotate(-20deg); } 50% { transform: rotate(20deg); } 100% { transform: rotate(-20deg); } }

        .admin-table-wrapper { overflow-x: auto; background: #111; border-radius: 8px; border: 1px solid #333; }
        .admin-table { width: 100%; border-collapse: collapse; min-width: 800px; }
        .admin-table th { background: #000; color: var(--accent); padding: 15px; text-transform: uppercase; font-size: 12px; border-bottom: 2px solid #333; text-align: left; }
        .admin-table td { padding: 12px; border-bottom: 1px solid #222; font-size: 13px; }

        .prod-btn-list { display: grid; grid-template-columns: 1fr; gap: 8px; }
        .prod-btn { background: #111; border: 1px solid #333; padding: 8px 12px; border-radius: 4px; color: white; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
        .prod-btn:hover { border-color: var(--accent); transform: translateX(5px); }

        .badge-type { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 11px; text-transform: uppercase; }
        .badge-green { background: rgba(46,204,113,0.2); color: #2ecc71; border: 1px solid #2ecc71; }
        .badge-red { background: rgba(231,76,60,0.2); color: #e74c3c; border: 1px solid #e74c3c; }

        .tab-chip { padding: 4px 10px; border-radius: 4px; background: #1a1a1a; border: 1px solid #333; color: #888; cursor: pointer; font-size: 12px; font-weight: bold; white-space: nowrap; }
        .tab-chip.active { background: var(--accent); color: black; border-color: var(--accent); }

        .cart-card { background: #111; border-radius: 10px; padding: 15px; margin-bottom: 12px; border: 1px solid #333; box-shadow: 0 4px 15px rgba(0,0,0,0.4); text-align: center; }
        
        .cantiere-container { background: #0d0d0d; border: 2px solid #333; border-radius: 12px; padding: 20px; box-shadow: inset 0 0 40px rgba(0,0,0,0.5); }
        .industrial-header { background: linear-gradient(90deg, #1a1a1a 0%, #252525 50%, #1a1a1a 100%); border: 1px solid #333; padding: 15px; border-radius: 8px 8px 0 0; margin: -20px -20px 20px -20px; display: flex; justify-content: center; align-items: center; border-bottom: 3px solid var(--accent); }
        .industrial-label { font-size: 10px; color: #666; text-transform: uppercase; letter-spacing: 2px; font-weight: bold; margin-bottom: 5px; display: block; }
        .tool-wrap { background: #151515; border: 1px solid #222; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .search-tool { border-left: 4px solid var(--accent) !important; height: 45px !important; }
        .prod-tile { background: #1a1a1a; border: 1px solid #333; border-radius: 6px; padding: 12px 15px; margin-bottom: 8px; display: flex; justify-content: space-between; cursor: pointer; }
        .prod-tile:hover { background: #222; border-right: 4px solid var(--accent); }
    </style>
</head>
<body>

    <!-- LOADER -->
    <div id="loader-overlay" class="hidden">
        <div style="position:relative; width:120px; height:120px; display:flex; justify-content:center; align-items:center;">
            <i class="bi bi-gear-fill loader-gear"></i>
            <i class="bi bi-wrench-adjustable loader-wrench"></i>
        </div>
        <div style="margin-top:30px; font-family:'Teko'; font-size:36px; color:white; letter-spacing:4px;">CARICAMENTO...</div>
    </div>

    <!-- LOGIN -->
    <div id="login-screen" class="bg-steel-login">
        <div class="vignette"></div>
        <div class="login-container">
            <div class="brand-stripe"></div>
            <img src="https://yt3.googleusercontent.com/ytc/AIdro_nC2KYqN62QVeGk8Fj8CAnW8dEJ4FNTgqqVC8dgSFaxgQ=s160-c-k-c0x00ffffff-no-rj" class="logo-circle">
            <h1 class="brand-title">CANTIERE <span style="color:var(--accent)">HAMBIRRERIA</span></h1>
            <div class="input-wrap"><i class="bi bi-person-fill"></i><input type="text" id="username" placeholder="IDENTIFICATIVO"></div>
            <div class="input-wrap"><i class="bi bi-key-fill"></i><input type="password" id="password" placeholder="PASSWORD" onkeydown="if(event.key === 'Enter') attemptLogin()"></div>
            <button class="btn-neon" onclick="attemptLogin()">ENTRA NEL SISTEMA</button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-screen" class="hidden bg-app-main">
        <div class="top-header">
            <button class="icon-btn" onclick="toggleMenu()"><i class="bi bi-list"></i></button>
            <div class="header-title" id="page-title">MAGAZZINO</div>
            <div class="user-badge" id="user-badge">USER</div>
        </div>

        <div id="sidebar-overlay" onclick="toggleMenu()"></div>
        <div id="sidebar">
            <div class="sidebar-top"><h2 style="margin:0; color:var(--accent); font-size:30px">MENU OFFICINA</h2></div>
            <div class="nav-links">
                <a onclick="nav('dashboard')" id="nav-dashboard"><i class="bi bi-box-seam"></i> Magazzino</a>
                <a onclick="nav('operations')" id="nav-operations"><i class="bi bi-arrow-left-right"></i> Operazioni</a>
                <a onclick="nav('dailylist')" id="nav-dailylist"><i class="bi bi-clipboard-check"></i> Lista Serale Cucina</a>
                
                <div class="admin-section hidden" id="admin-menu" style="border-top:1px solid #333; margin-top:10px; background:#0f0f0f">
                    <div style="padding:15px 20px; color:#666; font-size:12px; font-weight:bold">CAPO OFFICINA</div>
                    <a onclick="nav('admin-products')" id="nav-admin-products"><i class="bi bi-boxes"></i> Gestione Prodotti</a>
                    <a onclick="nav('admin-movements-log')" id="nav-admin-movements-log"><i class="bi bi-table"></i> Storico Movimenti</a>
                </div>
            </div>
            <div class="sidebar-footer"><button class="btn-logout" onclick="logout()">DISCONNESSIONE</button></div>
        </div>

        <div id="main-content">
            <div class="desktop-wrapper">
                
                <!-- DASHBOARD -->
                <div id="page-dashboard" class="page hidden">
                    <div class="search-wrapper"><i class="bi bi-search"></i><input type="text" id="dash-search" class="dark-input" placeholder="Cerca prodotto..." onkeyup="renderDashboard()"></div>
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <select id="dash-wh-filter" class="dark-select" onchange="renderDashboard()"></select>
                        <select id="dash-cat-filter" class="dark-select" onchange="renderDashboard()"></select>
                    </div>
                    <div id="dashboard-grid" class="grid-container"></div>
                </div>

                <!-- OPERATIONS -->
                <div id="page-operations" class="page hidden">
                    <div class="narrow-content-wrapper cantiere-container">
                        <div class="industrial-header"><h3 style="color:var(--accent); margin:0;"><i class="bi bi-hammer"></i> REGISTRA MOVIMENTO</h3></div>
                        
                        <div class="tool-wrap">
                            <span class="industrial-label">TIPO OPERAZIONE</span>
                            <select id="op-type-select" class="dark-input mb-3 border-start border-warning" onchange="updateOpTypeUI()">
                                <option value="CARICO">üü© ARRIVO MERCE (Carico)</option>
                                <option value="SCARICO CUCINA">üü• CARICHI CUCINA (Uscite)</option>
                                <option value="SPOSTAMENTO">üü® SPOSTAMENTO INTERNO</option>
                                <option value="RETTIFICA">‚öôÔ∏è RETTIFICA INVENTARIO</option>
                            </select>
                            
                            <div id="op-wh-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                                <div id="div-op-from"><label class="industrial-label">DA:</label><select id="op-from-wh" class="dark-input"></select></div>
                                <div id="div-op-to"><label class="industrial-label">A:</label><select id="op-to-wh" class="dark-input"></select></div>
                            </div>
                        </div>

                        <div class="tool-wrap" style="padding:10px">
                            <div class="search-wrapper mb-2"><i class="bi bi-search"></i><input type="text" id="op-search" class="dark-input search-tool" placeholder="Cerca attrezzatura..." onkeyup="renderOpSearch()"></div>
                            <div id="op-prod-list" style="max-height:280px; overflow-y:auto; padding:5px;"></div>
                        </div>

                        <span class="industrial-label text-center mt-4 text-warning"><i class="bi bi-clipboard-data"></i> CODA OPERAZIONI</span>
                        <div id="op-cart-list" style="min-height:80px; max-height:300px; overflow-y:auto; margin-bottom:20px; background:#1a1a1a; border-radius:8px; padding:10px;"></div>
                        
                        <button id="btn-confirm-op" class="btn-neon" onclick="submitOpMovements()" style="display:none;"><i class="bi bi-check-circle-fill"></i> CONFERMA E REGISTRA</button>
                    </div>
                </div>

                <!-- DAILY LIST (CUCINA) -->
                <div id="page-dailylist" class="page hidden">
                    <h3>LISTA SERALE CUCINA</h3>
                    <div class="tool-wrap">
                        <label class="industrial-label">SELEZIONA MAGAZZINO DA CONTROLLARE</label>
                        <select id="daily-wh" class="dark-select" onchange="renderDailyList(OP_ACTIVE_DEPT)"></select>
                    </div>
                    <div class="scrolling-tabs" id="dept-tabs"></div>
                    <div id="daily-list-body" style="padding-bottom:80px"></div>
                    <button class="btn-neon sticky" onclick="submitDaily()"><i class="bi bi-save"></i> SALVA RETTIFICHE</button>
                </div>

                <!-- ADMIN LOG -->
                <div id="page-admin-movements-log" class="page hidden">
                    <h3><i class="bi bi-table"></i> REGISTRO MOVIMENTI</h3>
                    <div class="admin-table-wrapper">
                        <table class="admin-table">
                            <thead><tr><th>Data</th><th>Utente</th><th>Articolo</th><th>Tipo</th><th>Pz Tot</th></tr></thead>
                            <tbody id="mov-log-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- ADMIN PRODOTTI -->
                <div id="page-admin-products" class="page hidden">
                    <h3><i class="bi bi-boxes"></i> GESTIONE PRODOTTI</h3>
                    <div class="search-wrapper"><i class="bi bi-search"></i><input type="text" id="admin-prod-search" class="dark-input" placeholder="Cerca prodotto..." onkeyup="renderAdminProds()"></div>
                    <div id="admin-prod-list"></div>
                </div>

            </div>
        </div>
    </div>

    <!-- Javascript Core (Supabase + Logic) -->
    <script>
        // CONFIGURAZIONE SUPABASE
        const supabaseUrl = 'https://jkekmxhrwwidkfoizhde.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImprZWtteGhyd3dpZGtmb2l6aGRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NjEwMTcsImV4cCI6MjA4NzAzNzAxN30.U_XxfpAR76Y7bhB_DdUu2CMeuIarR4158dgwITFRWAg';
        const _sb = supabase.createClient(supabaseUrl, supabaseKey);

        // VARIABILI GLOBALI
        let DB = { products: [], warehouses:[], inventory: {}, whMap: {} };
        let USER = null;
        let OP_CART =[];
        let OP_ACTIVE_CAT = 'ALL';
        let OP_ACTIVE_DEPT = 'GRIGLIA';
        let DAILY_DATA = {}; // Carrello lista serale
        
        // UTILITIES
        function showLoader(show) { document.getElementById('loader-overlay').style.display = show ? 'flex' : 'none'; }
        
        function renderQtyBadges(qty, prod) {
            if (!qty || qty <= 0) return '<span style="color:#444; font-size:12px; font-style:italic">0 pz</span>';
            let html = ''; let rem = qty;
            const pCrt = prod.Pezzi_per_Cartone || 1; const pPck = prod.Pezzi_per_Pacco || 1;
            if (pCrt > 1 && rem >= pCrt) { const c = Math.floor(rem / pCrt); rem %= pCrt; html += `<span class="unit-pill icon-box"><i class="bi bi-box-seam-fill"></i><b>${c}</b></span>`; }
            if (pPck > 1 && rem >= pPck) { const pk = Math.floor(rem / pPck); rem %= pPck; html += `<span class="unit-pill icon-pack"><i class="bi bi-archive-fill"></i><b>${pk}</b></span>`; }
            if (rem > 0 || html === '') { html += `<span class="unit-pill icon-piece"><i class="bi bi-gear-wide-connected"></i><b>${rem}</b></span>`; }
            return html;
        }

        // AUTHENTICATION
        window.onload = () => {
            const saved = localStorage.getItem('cantiere_user');
            if(saved) { USER = JSON.parse(saved); initApp(); }
        };

        async function attemptLogin() {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            if(!u || !p) return Swal.fire('Errore', 'Inserisci i dati', 'error');

            showLoader(true);
            try {
                // Fetch direct from table (Assuming custom table 'utenti_app')
                const { data, error } = await _sb.from('utenti_app').select('*').eq('username', u).eq('password', p).single();
                if(error || !data) throw new Error("Credenziali errate");

                USER = { id: data.id, username: data.username, role: data.ruolo };
                localStorage.setItem('cantiere_user', JSON.stringify(USER));
                initApp();
            } catch (err) {
                Swal.fire('Accesso Negato', err.message, 'error');
            } finally {
                showLoader(false);
            }
        }

        function logout() {
            localStorage.removeItem('cantiere_user');
            window.location.reload();
        }

        // INITIALIZATION & DATA FETCHING
        async function initApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('user-badge').innerText = USER.username.toUpperCase();
            if(USER.role === 'admin') document.getElementById('admin-menu').classList.remove('hidden');
            
            await loadDataFromSupabase();
            nav('dashboard');
        }

        async function loadDataFromSupabase() {
            showLoader(true);
            try {
                // 1. Fetch Prodotti (Mapped to legacy properties to avoid UI rewrite)
                const { data: prods } = await _sb.from('prodotti').select('*').order('nome_prodotto');
                DB.products = prods.map(p => ({
                    ID_Prodotto: p.id,
                    Nome: p.nome_prodotto,
                    Categoria: p.categoria || 'Varie',
                    Fornitore: p.fornitore || '-',
                    Reparto: p.reparto || 'Generale',
                    Pezzi_per_Cartone: p.pezzi_per_cartone || 1,
                    Pezzi_per_Pacco: p.pezzi_per_pacco || 1
                }));

                // 2. Fetch Magazzini
                const { data: mags } = await _sb.from('magazzini').select('*').order('nome');
                DB.warehouses = mags.map(m => m.nome);
                DB.whMap = {}; mags.forEach(m => DB.whMap = m.id);

                // 3. Fetch Giacenze and build dictionary
                const { data: giac } = await _sb.from('giacenze').select('*, magazzini(nome)');
                DB.inventory = {};
                giac.forEach(g => {
                    if(!DB.inventory) DB.inventory = {};
                    if(g.magazzini) DB.inventory = g.quantita_totale_pezzi;
                });

                updateSelectFilters();
            } catch(e) {
                Swal.fire('Errore Sync', e.message, 'error');
            } finally {
                showLoader(false);
            }
        }

        function updateSelectFilters() {
            const whOpts = DB.warehouses.map(w => `<option value="${w}">${w}</option>`).join('');
            
            // Dashboard
            document.getElementById('dash-wh-filter').innerHTML = '<option value="ALL">TOTALE OFFICINA</option>' + whOpts;
            const cats =.sort();
            document.getElementById('dash-cat-filter').innerHTML = '<option value="ALL">TUTTE LE CATEGORIE</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');

            // Operations
            document.getElementById('op-from-wh').innerHTML = whOpts;
            document.getElementById('op-to-wh').innerHTML = whOpts;

            // Daily list
            document.getElementById('daily-wh').innerHTML = whOpts;
        }

        // NAVIGATION
        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('sidebar-overlay').classList.toggle('active');
        }

        async function nav(page) {
            document.querySelectorAll('.page').forEach(e => e.classList.add('hidden'));
            document.querySelectorAll('.nav-links a').forEach(e => e.classList.remove('active'));
            document.getElementById('page-' + page).classList.remove('hidden');
            if(document.getElementById('nav-' + page)) document.getElementById('nav-' + page).classList.add('active');
            
            const titles = { 'dashboard': 'MAGAZZINO', 'operations': 'OPERAZIONI', 'dailylist': 'LISTA SERALE', 'admin-products': 'PRODOTTI', 'admin-movements-log': 'REGISTRO MOVIMENTI'};
            document.getElementById('page-title').innerText = titles || page.toUpperCase();
            
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebar-overlay').classList.remove('active');

            if(page === 'dashboard') renderDashboard();
            if(page === 'operations') { OP_CART =[]; renderOpCart(); updateOpTypeUI(); }
            if(page === 'dailylist') renderDailyList('GRIGLIA');
            if(page === 'admin-products') renderAdminProds();
            if(page === 'admin-movements-log') loadMovementsLog();
        }

        // DASHBOARD
        function renderDashboard() {
            const q = document.getElementById('dash-search').value.toLowerCase();
            const wh = document.getElementById('dash-wh-filter').value;
            const cat = document.getElementById('dash-cat-filter').value;
            const grid = document.getElementById('dashboard-grid');
            grid.innerHTML = '';

            DB.products.forEach(p => {
                if (q && !p.Nome.toLowerCase().includes(q)) return;
                if (cat !== 'ALL' && p.Categoria !== cat) return;

                let total = 0;
                const inv = DB.inventory || {};
                if (wh === 'ALL') { Object.values(inv).forEach(v => total += v); } 
                else { total = inv || 0; }

                grid.innerHTML += `
                    <div class="card-item">
                        <h4 class="text-warning">${p.Nome}</h4>
                        <div style="font-size:11px; color:#888">${p.Categoria}</div>
                        <div class="mt-2">${renderQtyBadges(total, p)}</div>
                        <div class="total-row">${total} <span style="font-size:12px; color:#888">pz</span></div>
                    </div>`;
            });
        }

        // OPERATIONS
        function updateOpTypeUI() {
            const t = document.getElementById('op-type-select').value;
            const dFrom = document.getElementById('div-op-from');
            const dTo = document.getElementById('div-op-to');
            
            dFrom.style.display = 'block'; dTo.style.display = 'block';
            if(t === 'CARICO') dFrom.style.display = 'none';
            if(t === 'SCARICO CUCINA' || t === 'RETTIFICA') dTo.style.display = 'none';
            renderOpSearch();
        }

        function renderOpSearch() {
            const q = document.getElementById('op-search').value.toLowerCase();
            const div = document.getElementById('op-prod-list'); div.innerHTML = '';
            
            DB.products.filter(p => !q || p.Nome.toLowerCase().includes(q)).slice(0, 30).forEach(p => {
                div.innerHTML += `<div class="prod-tile" onclick='openQtyPopup(${JSON.stringify(p).replace(/'/g, "&apos;")}, "OP")'><b>${p.Nome}</b><i class="bi bi-chevron-right"></i></div>`;
            });
        }

        function openQtyPopup(p, context) {
            window.tempP = p;
            Swal.fire({
                title: p.Nome,
                html: `
                <div class="swal-grid">
                    <div class="swal-field"><label>CARTONI (x${p.Pezzi_per_Cartone})</label><input id="s-c" type="number" min="0" value="0" oninput="uPT()"></div>
                    <div class="swal-field"><label>PACCHI (x${p.Pezzi_per_Pacco})</label><input id="s-pk" type="number" min="0" value="0" oninput="uPT()"></div>
                    <div class="swal-field"><label>SFUSI</label><input id="s-ps" type="number" min="0" value="0" oninput="uPT()"></div>
                </div>
                <div class="mt-3" style="font-family:'Teko'; font-size:24px; color:var(--accent)">Totale: <b id="s-t">0</b> pz</div>`,
                showCancelButton: true, confirmButtonText: 'AGGIUNGI',
                preConfirm: () => {
                    const c = parseInt(document.getElementById('s-c').value||0);
                    const pk = parseInt(document.getElementById('s-pk').value||0);
                    const ps = parseInt(document.getElementById('s-ps').value||0);
                    return (c * p.Pezzi_per_Cartone) + (pk * p.Pezzi_per_Pacco) + ps;
                }
            }).then(res => {
                if(res.isConfirmed && res.value > 0 || (context==='DAILY' && res.isConfirmed)) {
                    if(context === 'OP') addToOpCart(p, res.value);
                    if(context === 'DAILY') { DAILY_DATA = res.value; renderDailyList(OP_ACTIVE_DEPT); }
                }
            });
        }
        function uPT() {
            const p = window.tempP;
            const c = parseInt(document.getElementById('s-c').value||0) * p.Pezzi_per_Cartone;
            const pk = parseInt(document.getElementById('s-pk').value||0) * p.Pezzi_per_Pacco;
            const ps = parseInt(document.getElementById('s-ps').value||0);
            document.getElementById('s-t').innerText = c + pk + ps;
        }

        function addToOpCart(p, totPz) {
            const t = document.getElementById('op-type-select').value;
            const f = document.getElementById('op-from-wh').value;
            const to = document.getElementById('op-to-wh').value;
            OP_CART.push({ p, tot: totPz, type: t, from: f, to: to });
            renderOpCart();
        }

        function renderOpCart() {
            const div = document.getElementById('op-cart-list');
            const btn = document.getElementById('btn-confirm-op');
            div.innerHTML = OP_CART.length ? '' : '<div class="text-center text-secondary">Nessuna operazione in coda</div>';
            btn.style.display = OP_CART.length ? 'block' : 'none';

            OP_CART.forEach((it, i) => {
                let path = '';
                if(it.type === 'CARICO') path = `IN -> ${it.to}`;
                else if(it.type === 'SCARICO CUCINA') path = `${it.from} -> OUT`;
                else if(it.type === 'RETTIFICA') path = `RETTIFICA -> ${it.from}`;
                else path = `${it.from} -> ${it.to}`;

                div.innerHTML += `
                <div class="cart-item-row">
                    <div>
                        <b class="text-white">${it.p.Nome}</b><br>
                        <span class="badge bg-dark border border-secondary text-warning">${it.type}</span> 
                        <span style="font-size:11px; color:#aaa">${path}</span>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <b style="font-size:18px; color:var(--accent)">${it.tot} pz</b>
                        <i class="bi bi-x-circle cart-del-btn" onclick="OP_CART.splice(${i},1); renderOpCart()"></i>
                    </div>
                </div>`;
            });
        }

        // SUPABASE MOVEMENT EXECUTION
        async function submitOpMovements() {
            if(!OP_CART.length) return;
            showLoader(true);
            try {
                for(let item of OP_CART) {
                    const pId = item.p.ID_Prodotto;
                    const idFrom = DB.whMap;
                    const idTo = DB.whMap;
                    
                    if(item.type === 'CARICO') {
                        await _updateGiacenza(pId, idTo, item.tot, true);
                        await _logMovimento(pId, null, idTo, 'CARICO', item.tot);
                    } else if (item.type === 'SCARICO CUCINA') {
                        await _updateGiacenza(pId, idFrom, -item.tot, true);
                        await _logMovimento(pId, idFrom, null, 'SCARICO CUCINA', item.tot);
                    } else if (item.type === 'SPOSTAMENTO') {
                        await _updateGiacenza(pId, idFrom, -item.tot, true);
                        await _updateGiacenza(pId, idTo, item.tot, true);
                        await _logMovimento(pId, idFrom, idTo, 'SPOSTAMENTO', item.tot);
                    } else if (item.type === 'RETTIFICA') {
                        await _updateGiacenza(pId, idFrom, item.tot, false); // false = absolute value override
                        await _logMovimento(pId, idFrom, null, 'RETTIFICA', item.tot);
                    }
                }
                Swal.fire('Successo', 'Operazioni Registrate', 'success');
                OP_CART =[]; renderOpCart();
                await loadDataFromSupabase(); // refresh DB
            } catch(e) {
                Swal.fire('Errore', e.message, 'error');
            } finally {
                showLoader(false);
            }
        }

        async function _updateGiacenza(pId, mId, delta, isRelative) {
            const { data: es } = await _sb.from('giacenze').select('*').eq('prodotto_id', pId).eq('magazzino_id', mId).maybeSingle();
            const oldVal = es ? es.quantita_totale_pezzi : 0;
            const newVal = isRelative ? oldVal + delta : delta; // delta is absolute if !isRelative
            await _sb.from('giacenze').upsert({ id: es?.id, prodotto_id: pId, magazzino_id: mId, quantita_totale_pezzi: newVal });
        }

        async function _logMovimento(pId, mFrom, mTo, tipo, qta) {
            await _sb.from('movimenti').insert({ prodotto_id: pId, magazzino_origine_id: mFrom, magazzino_destinazione_id: mTo, tipo_movimento: tipo, quantita_pezzi: qta, utente_id: USER.id });
        }

        // DAILY LIST (LISTA SERALE CUCINA)
        function renderDailyList(dept) {
            OP_ACTIVE_DEPT = dept;
            const tabs =;
            document.getElementById('dept-tabs').innerHTML = tabs.map(d => `<div class="tab-chip ${d === dept ? 'active' : ''}" onclick="renderDailyList('${d}')">${d}</div>`).join('');
            
            const div = document.getElementById('daily-list-body'); div.innerHTML = '';
            const wh = document.getElementById('daily-wh').value;

            const prods = DB.products.filter(p => p.Reparto === dept);
            prods.forEach(p => {
                const entered = DAILY_DATA;
                const invTeorico = DB.inventory ? (DB.inventory || 0) : 0;
                
                let valHtml = entered !== undefined ? 
                    `<b style="color:var(--accent); font-size:18px">${entered} pz</b>` : 
                    `<span style="color:#666; font-size:12px">Teorico: ${invTeorico}</span>`;

                div.innerHTML += `
                    <div class="prod-btn mb-2" onclick='openQtyPopup(${JSON.stringify(p).replace(/'/g, "&apos;")}, "DAILY")'>
                        <div><b>${p.Nome}</b><br><small style="color:#888">${p.Categoria}</small></div>
                        <div class="text-end">${valHtml}</div>
                    </div>`;
            });
        }

        async function submitDaily() {
            if(Object.keys(DAILY_DATA).length === 0) return Swal.fire('Attenzione', 'Nessun conteggio inserito', 'info');
            const wh = document.getElementById('daily-wh').value;
            const whId = DB.whMap;

            showLoader(true);
            try {
                // Genera movimenti di rettifica automatici per calcolare il delta
                for(let pId in DAILY_DATA) {
                    const pIdNum = parseInt(pId);
                    const contato = DAILY_DATA;
                    const teorico = DB.inventory ? (DB.inventory || 0) : 0;
                    
                    if(contato !== teorico) {
                        await _updateGiacenza(pIdNum, whId, contato, false); // Override assoluto
                        const note = `Rettifica Serale ${wh}. Teorico: ${teorico}, Contato: ${contato}`;
                        await _sb.from('movimenti').insert({ prodotto_id: pIdNum, magazzino_origine_id: whId, tipo_movimento: 'RETTIFICA', quantita_pezzi: contato, utente_id: USER.id, note: note });
                    }
                }
                DAILY_DATA = {};
                await loadDataFromSupabase();
                renderDailyList(OP_ACTIVE_DEPT);
                Swal.fire('Successo', 'Allineamento completato!', 'success');
            } catch(e) {
                Swal.fire('Errore', e.message, 'error');
            } finally {
                showLoader(false);
            }
        }

        // ADMIN LOG
        async function loadMovementsLog() {
            showLoader(true);
            try {
                const { data } = await _sb.from('movimenti').select('*, prodotti(nome_prodotto), utenti_app(username)').order('data_movimento', {ascending: false}).limit(100);
                const tbody = document.getElementById('mov-log-body');
                tbody.innerHTML = data.map(m => {
                    const color = m.tipo_movimento.includes('SCARICO') ? 'text-danger' : (m.tipo_movimento === 'CARICO' ? 'text-success' : 'text-warning');
                    return `<tr>
                        <td>${new Date(m.data_movimento).toLocaleString('it-IT').slice(0,16)}</td>
                        <td>${m.utenti_app ? m.utenti_app.username : 'Sistema'}</td>
                        <td><b>${m.prodotti ? m.prodotti.nome_prodotto : 'Sconosciuto'}</b></td>
                        <td class="${color} fw-bold">${m.tipo_movimento}</td>
                        <td class="text-white fw-bold">${m.quantita_pezzi}</td>
                    </tr>`;
                }).join('');
            } finally {
                showLoader(false);
            }
        }

        // ADMIN PRODOTTI (Visualizzazione Semplice)
        function renderAdminProds() {
            const q = document.getElementById('admin-prod-search').value.toLowerCase();
            const div = document.getElementById('admin-prod-list');
            div.innerHTML = DB.products.filter(p => !q || p.Nome.toLowerCase().includes(q)).map(p => `
                <div class="prod-tile mb-2" style="cursor:default;">
                    <div><b class="text-warning">${p.Nome}</b><br><small class="text-secondary">Cat: ${p.Categoria} | Forn: ${p.Fornitore}</small></div>
                    <div class="text-end text-secondary small">1 CT = ${p.Pezzi_per_Cartone} pz<br>1 PK = ${p.Pezzi_per_Pacco} pz</div>
                </div>`).join('');
        }
    </script>
</body>
</html>
