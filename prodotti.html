<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Cantiere | Gestione Prodotti</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --cantiere-gold: #ffc107; --cantiere-dark: #121212; }
        body { background-color: var(--cantiere-dark); color: #fff; font-family: 'Inter', sans-serif; }
        .navbar { background: #000; border-bottom: 2px solid var(--cantiere-gold); }
        .card-prodotto { background: #1e1e1e; border: 1px solid #333; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; }
        .form-control { background: #2a2a2a; border: 1px solid #444; color: #fff; }
        .form-control:focus { background: #2a2a2a; color: #fff; border-color: var(--cantiere-gold); box-shadow: none; }
    </style>
</head>
<body>

<nav class="navbar p-3">
    <div class="container-fluid">
        <a href="dashboard.html" class="text-white text-decoration-none fw-bold"><i class="bi bi-arrow-left me-2"></i> DASHBOARD</a>
        <button class="btn btn-warning btn-sm fw-bold" onclick="nuovoProdotto()">+ AGGIUNGI PRODOTTO</button>
    </div>
</nav>

<div class="container mt-4">
    <div class="row" id="prodList"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const user = JSON.parse(localStorage.getItem('cantiere_user'));
    if(!user || user.ruolo !== 'admin') location.href='dashboard.html';

    const _supabase = supabase.createClient("https://jkekmxhrwwidkfoizhde.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImprZWtteGhyd3dpZGtmb2l6aGRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NjEwMTcsImV4cCI6MjA4NzAzNzAxN30.U_XxfpAR76Y7bhB_DdUu2CMeuIarR4158dgwITFRWAg");

    async function caricaProdotti() {
        const { data } = await _supabase.from('prodotti').select('*').order('nome_prodotto');
        document.getElementById('prodList').innerHTML = data.map(p => `
            <div class="col-md-4">
                <div class="card-prodotto">
                    <h5 class="fw-bold text-warning">${p.nome_prodotto}</h5>
                    <div class="small text-secondary mb-3">
                        <i class="bi bi-boxes"></i> Cartone: ${p.pezzi_per_cartone} pz<br>
                        <i class="bi bi-box-fill"></i> Pacco: ${p.pezzi_per_pacco} pz
                    </div>
                    <button class="btn btn-outline-light btn-sm w-100" onclick="elimina('${p.id}')">Elimina</button>
                </div>
            </div>
        `).join('');
    }

    async function nuovoProdotto() {
        const { value: formValues } = await Swal.fire({
            title: 'Nuovo Prodotto',
            html:
                '<input id="swal-n" class="swal2-input" placeholder="Nome Prodotto">' +
                '<input id="swal-c" type="number" class="swal2-input" placeholder="Pezzi per Cartone">' +
                '<input id="swal-p" type="number" class="swal2-input" placeholder="Pezzi per Pacco">',
            focusConfirm: false,
            confirmButtonColor: '#ffc107',
            preConfirm: () => {
                return {
                    nome: document.getElementById('swal-n').value,
                    ct: document.getElementById('swal-c').value,
                    pk: document.getElementById('swal-p').value
                }
            }
        });

        if (formValues && formValues.nome) {
            await _supabase.from('prodotti').insert([{ 
                nome_prodotto: formValues.nome, 
                pezzi_per_cartone: formValues.ct || 1, 
                pezzi_per_pacco: formValues.pk || 1 
            }]);
            caricaProdotti();
        }
    }

    async function elimina(id) {
        const confirm = await Swal.fire({ title: 'Sei sicuro?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' });
        if(confirm.isConfirmed) {
            await _supabase.from('prodotti').delete().eq('id', id);
            caricaProdotti();
        }
    }

    caricaProdotti();
</script>
</body>
</html>
