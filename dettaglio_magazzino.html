<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Cantiere | Scorte</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #121212; color: #fff; }
        .table-cantiere { background: #1e1e1e; border: 1px solid #333; }
        .text-gold { color: #ffc107; }
        .total-box { background: #ffc107; color: #000; font-weight: bold; padding: 2px 8px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between mb-4">
            <h2 id="title" class="fw-bold text-gold"></h2>
            <a href="dashboard.html" class="btn btn-outline-light">INDIETRO</a>
        </div>
        <table class="table table-dark table-cantiere">
            <thead>
                <tr>
                    <th>PRODOTTO</th>
                    <th class="text-center"><i class="bi bi-boxes"></i> CARTONI</th>
                    <th class="text-center"><i class="bi bi-box-fill"></i> PACCHI</th>
                    <th class="text-center"><i class="bi bi-gear-fill text-gold"></i> PEZZI</th>
                    <th class="text-end">TOT PEZZI</th>
                </tr>
            </thead>
            <tbody id="lista"></tbody>
        </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        if(!localStorage.getItem('cantiere_user')) location.href='index.html';
        const params = new URLSearchParams(window.location.search);
        document.getElementById('title').innerText = params.get('nome');
        const _supabase = supabase.createClient("https://jkekmxhrwwidkfoizhde.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImprZWtteGhyd3dpZGtmb2l6aGRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NjEwMTcsImV4cCI6MjA4NzAzNzAxN30.U_XxfpAR76Y7bhB_DdUu2CMeuIarR4158dgwITFRWAg");

        async function carica() {
            const { data } = await _supabase.from('giacenze').select('*, prodotti(*)').eq('magazzino_id', params.get('id'));
            document.getElementById('lista').innerHTML = data.map(g => {
                const p = g.prodotti;
                const ct = Math.floor(g.quantita_totale_pezzi / p.pezzi_per_cartone);
                const r = g.quantita_totale_pezzi % p.pezzi_per_cartone;
                const pk = Math.floor(r / p.pezzi_per_pacco);
                const pz = r % p.pezzi_per_pacco;
                return `<tr>
                    <td>${p.nome_prodotto}</td>
                    <td class="text-center h5">${ct}</td>
                    <td class="text-center h5">${pk}</td>
                    <td class="text-center h5 text-secondary">${pz}</td>
                    <td class="text-end"><span class="total-box">${g.quantita_totale_pezzi}</span></td>
                </tr>`;
            }).join('');
        }

        // REALTIME
        _supabase.channel('room1').on('postgres_changes', { event: '*', schema: 'public', table: 'giacenze' }, () => carica()).subscribe();
        carica();
    </script>
</body>
</html>
